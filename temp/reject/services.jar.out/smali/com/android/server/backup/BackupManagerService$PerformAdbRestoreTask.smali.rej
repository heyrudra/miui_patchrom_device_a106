*** BackupManagerService$PerformAdbRestoreTask.smali	2018-02-09 22:28:21.782213404 +0530
--- BackupManagerService$PerformAdbRestoreTask.smali	2018-02-09 22:17:59.312710580 +0530
***************
*** 1512,1518 ****
  
      iput-wide v0, v2, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mBytes:J
  
-     :cond_0
      const/16 v18, 0x0
  
      move/from16 v0, v18
--- 1512,1517 ----
  
      iput-wide v0, v2, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mBytes:J
  
      const/16 v18, 0x0
  
      move/from16 v0, v18
***************
*** 2518,2529 ****
      iget v6, v0, Landroid/content/pm/ApplicationInfo;->flags:I
  
      .local v6, "flags":I
      const v17, 0x8000
  
      and-int v17, v17, v6
  
      if-eqz v17, :cond_9
  
      iget-object v0, v12, Landroid/content/pm/PackageInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
  
      move-object/from16 v17, v0
--- 2517,2545 ----
      iget v6, v0, Landroid/content/pm/ApplicationInfo;->flags:I
  
      .local v6, "flags":I
+     move-object/from16 v0, p0
+ 
+     iget-object v0, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mInputFile:Landroid/os/ParcelFileDescriptor;
+ 
+     move-object/from16 v17, v0
+ 
+     invoke-virtual/range {v17 .. v17}, Landroid/os/ParcelFileDescriptor;->getFd()I
+ 
+     move-result v17
+ 
+     invoke-static/range {v17 .. v17}, Lcom/android/server/backup/BackupManagerServiceInjector;->isForceAllowBackup(I)Z
+ 
+     move-result v17
+ 
+     if-nez v17, :cond_miui_4
+ 
      const v17, 0x8000
  
      and-int v17, v17, v6
  
      if-eqz v17, :cond_9
  
+     :cond_miui_4
      iget-object v0, v12, Landroid/content/pm/PackageInfo;->applicationInfo:Landroid/content/pm/ApplicationInfo;
  
      move-object/from16 v17, v0
***************
*** 4773,4778 ****
      check-cast v40, Lcom/android/server/backup/BackupManagerService$RestorePolicy;
  
      .local v40, "policy":Lcom/android/server/backup/BackupManagerService$RestorePolicy;
      sget-object v5, Lcom/android/server/backup/BackupManagerService$6;->$SwitchMap$com$android$server$backup$BackupManagerService$RestorePolicy:[I
  
      invoke-virtual/range {v40 .. v40}, Lcom/android/server/backup/BackupManagerService$RestorePolicy;->ordinal()I
--- 4789,4808 ----
      check-cast v40, Lcom/android/server/backup/BackupManagerService$RestorePolicy;
  
      .local v40, "policy":Lcom/android/server/backup/BackupManagerService$RestorePolicy;
+     move-object/from16 v0, v33
+ 
+     iget-wide v8, v0, Lcom/android/server/backup/BackupManagerService$FileMetadata;->size:J
+ 
+     move-object/from16 v0, p0
+ 
+     iget-object v5, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mInputFile:Landroid/os/ParcelFileDescriptor;
+ 
+     invoke-virtual {v5}, Landroid/os/ParcelFileDescriptor;->getFd()I
+ 
+     move-result v5
+ 
+     invoke-static {v8, v9, v5}, Lcom/android/server/backup/BackupManagerServiceInjector;->addRestoredSize(JI)V
+ 
      sget-object v5, Lcom/android/server/backup/BackupManagerService$6;->$SwitchMap$com$android$server$backup$BackupManagerService$RestorePolicy:[I
  
      invoke-virtual/range {v40 .. v40}, Lcom/android/server/backup/BackupManagerService$RestorePolicy;->ordinal()I
***************
*** 4881,4894 ****
  
      iget-object v5, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->this$0:Lcom/android/server/backup/BackupManagerService;
  
!     # getter for: Lcom/android/server/backup/BackupManagerService;->mPackageManager:Landroid/content/pm/PackageManager;
!     invoke-static {v5}, Lcom/android/server/backup/BackupManagerService;->access$400(Lcom/android/server/backup/BackupManagerService;)Landroid/content/pm/PackageManager;
  
!     move-result-object v5
  
!     const/4 v7, 0x0
  
!     invoke-virtual {v5, v6, v7}, Landroid/content/pm/PackageManager;->getApplicationInfo(Ljava/lang/String;I)Landroid/content/pm/ApplicationInfo;
  
      move-result-object v5
  
--- 4911,4927 ----
  
      iget-object v5, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->this$0:Lcom/android/server/backup/BackupManagerService;
  
!     iget-object v5, v5, Lcom/android/server/backup/BackupManagerService;->mContext:Landroid/content/Context;
  
!     move-object/from16 v0, p0
  
!     iget-object v7, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mInputFile:Landroid/os/ParcelFileDescriptor;
  
!     invoke-virtual {v7}, Landroid/os/ParcelFileDescriptor;->getFd()I
! 
!     move-result v7
! 
!     invoke-static {v5, v6, v7}, Lcom/android/server/backup/BackupManagerServiceInjector;->getApplicationInfo(Landroid/content/Context;Ljava/lang/String;I)Landroid/content/pm/ApplicationInfo;
  
      move-result-object v5
  
***************
*** 6384,6389 ****
      const-string v22, "Invalid restore data; aborting."
  
      invoke-static/range {v21 .. v22}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
      :try_end_8
      .catch Ljava/io/IOException; {:try_start_8 .. :try_end_8} :catch_1
      .catchall {:try_start_8 .. :try_end_8} :catchall_2
--- 6474,6493 ----
      const-string v22, "Invalid restore data; aborting."
  
      invoke-static/range {v21 .. v22}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
+ 
+     const/16 v21, 0x1
+ 
+     move-object/from16 v0, p0
+ 
+     iget-object v0, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mInputFile:Landroid/os/ParcelFileDescriptor;
+ 
+     move-object/from16 v22, v0
+ 
+     invoke-virtual/range {v22 .. v22}, Landroid/os/ParcelFileDescriptor;->getFd()I
+ 
+     move-result v22
+ 
+     invoke-static/range {v21 .. v22}, Lcom/android/server/backup/BackupManagerServiceInjector;->errorOccur(II)V
      :try_end_8
      .catch Ljava/io/IOException; {:try_start_8 .. :try_end_8} :catch_1
      .catchall {:try_start_8 .. :try_end_8} :catchall_2
***************
*** 6581,6590 ****
  
      move-result-object v14
  
!     if-eqz v14, :cond_4
  
      const/4 v12, 0x1
  
      goto/16 :goto_4
  
      :cond_a
--- 6685,6711 ----
  
      move-result-object v14
  
!     if-eqz v14, :cond_miui_7
  
      const/4 v12, 0x1
  
+     :cond_miui_7
+     if-nez v14, :cond_4
+ 
+     const/16 v21, 0x3
+ 
+     move-object/from16 v0, p0
+ 
+     iget-object v0, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mInputFile:Landroid/os/ParcelFileDescriptor;
+ 
+     move-object/from16 v22, v0
+ 
+     invoke-virtual/range {v22 .. v22}, Landroid/os/ParcelFileDescriptor;->getFd()I
+ 
+     move-result v22
+ 
+     invoke-static/range {v21 .. v22}, Lcom/android/server/backup/BackupManagerServiceInjector;->errorOccur(II)V
+     
      goto/16 :goto_4
  
      :cond_a
***************
*** 6593,6598 ****
      const-string v22, "Archive is encrypted but no password given"
  
      invoke-static/range {v21 .. v22}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
      :try_end_c
      .catch Ljava/io/IOException; {:try_start_c .. :try_end_c} :catch_1
      .catchall {:try_start_c .. :try_end_c} :catchall_2
--- 6714,6733 ----
      const-string v22, "Archive is encrypted but no password given"
  
      invoke-static/range {v21 .. v22}, Landroid/util/Slog;->w(Ljava/lang/String;Ljava/lang/String;)I
+     
+     const/16 v21, 0x3
+ 
+     move-object/from16 v0, p0
+ 
+     iget-object v0, v0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mInputFile:Landroid/os/ParcelFileDescriptor;
+ 
+     move-object/from16 v22, v0
+ 
+     invoke-virtual/range {v22 .. v22}, Landroid/os/ParcelFileDescriptor;->getFd()I
+ 
+     move-result v22
+ 
+     invoke-static/range {v21 .. v22}, Lcom/android/server/backup/BackupManagerServiceInjector;->errorOccur(II)V
      :try_end_c
      .catch Ljava/io/IOException; {:try_start_c .. :try_end_c} :catch_1
      .catchall {:try_start_c .. :try_end_c} :catchall_2
***************
*** 7635,7640 ****
  
      if-nez v1, :cond_1
  
      const-string v1, "BackupManagerService"
  
      const-string v2, "Killing host process"
--- 7810,7829 ----
  
      if-nez v1, :cond_1
  
+     iget-object v1, p1, Landroid/content/pm/ApplicationInfo;->packageName:Ljava/lang/String;
+ 
+     iget-object v2, p0, Lcom/android/server/backup/BackupManagerService$PerformAdbRestoreTask;->mInputFile:Landroid/os/ParcelFileDescriptor;
+ 
+     invoke-virtual {v2}, Landroid/os/ParcelFileDescriptor;->getFd()I
+ 
+     move-result v2
+ 
+     invoke-static {v1, v2}, Lcom/android/server/backup/BackupManagerServiceInjector;->isNeedBeKilled(Ljava/lang/String;I)Z
+ 
+     move-result v1
+ 
+     if-eqz v1, :cond_1
+ 
      const-string v1, "BackupManagerService"
  
      const-string v2, "Killing host process"
