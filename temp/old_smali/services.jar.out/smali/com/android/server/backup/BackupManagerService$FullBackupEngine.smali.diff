*** ./smali/com/android/server/backup/BackupManagerService$FullBackupEngine.smali	2018-02-09 22:28:21.470214656 +0530
--- /root/prithvi/patchrom/device/temp/new_smali/services.jar.out/./smali/com/android/server/backup/BackupManagerService$FullBackupEngine.smali	2018-02-09 22:17:59.052711623 +0530
***************
*** 138,144 ****
  .end method
  
  .method private tearDown(Landroid/content/pm/PackageInfo;)V
!     .locals 2
      .param p1, "pkg"    # Landroid/content/pm/PackageInfo;
  
      .prologue
--- 138,144 ----
  .end method
  
  .method private tearDown(Landroid/content/pm/PackageInfo;)V
!     .locals 3
      .param p1, "pkg"    # Landroid/content/pm/PackageInfo;
  
      .prologue
***************
*** 151,156 ****
--- 151,175 ----
  
      iget-object v1, p0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->this$0:Lcom/android/server/backup/BackupManagerService;
  
+     # getter for: Lcom/android/server/backup/BackupManagerService;->mActivityManager:Landroid/app/IActivityManager;
+     invoke-static {v1}, Lcom/android/server/backup/BackupManagerService;->access$700(Lcom/android/server/backup/BackupManagerService;)Landroid/app/IActivityManager;
+ 
+     move-result-object v1
+ 
+     iget-object v2, p0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->mOutputFile:Landroid/os/ParcelFileDescriptor;
+ 
+     invoke-virtual {v2}, Landroid/os/ParcelFileDescriptor;->getFd()I
+ 
+     move-result v2
+ 
+     invoke-static {v1, v0, v2}, Lcom/android/server/backup/BackupManagerServiceInjector;->tearDownAgentAndKill(Landroid/app/IActivityManager;Landroid/content/pm/ApplicationInfo;I)Z
+ 
+     move-result v1
+ 
+     if-nez v1, :cond_0
+ 
+     iget-object v1, p0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->this$0:Lcom/android/server/backup/BackupManagerService;
+ 
      invoke-virtual {v1, v0}, Lcom/android/server/backup/BackupManagerService;->tearDownAgentAndKill(Landroid/content/pm/ApplicationInfo;)V
  
      .end local v0    # "app":Landroid/content/pm/ApplicationInfo;
***************
*** 586,591 ****
--- 605,620 ----
      .local v4, "agent":Landroid/app/IBackupAgent;
      if-eqz v4, :cond_a
  
+     move-object/from16 v0, p0
+ 
+     iget-object v2, v0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->mOutputFile:Landroid/os/ParcelFileDescriptor;
+ 
+     invoke-virtual {v2}, Landroid/os/ParcelFileDescriptor;->getFd()I
+ 
+     move-result v2
+ 
+     invoke-static {v4, v2}, Lcom/android/server/backup/BackupManagerServiceInjector;->linkToDeath(Landroid/app/IBackupAgent;I)V
+ 
      const/4 v13, 0x0
  
      .local v13, "pipes":[Landroid/os/ParcelFileDescriptor;
***************
*** 735,748 ****
  
      iget-object v5, v0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->mOutput:Ljava/io/OutputStream;
  
!     # invokes: Lcom/android/server/backup/BackupManagerService;->routeSocketDataToOutput(Landroid/os/ParcelFileDescriptor;Ljava/io/OutputStream;)V
!     invoke-static {v2, v3, v5}, Lcom/android/server/backup/BackupManagerService;->access$800(Lcom/android/server/backup/BackupManagerService;Landroid/os/ParcelFileDescriptor;Ljava/io/OutputStream;)V
      :try_end_1
      .catch Ljava/io/IOException; {:try_start_1 .. :try_end_1} :catch_0
      .catchall {:try_start_1 .. :try_end_1} :catchall_0
  
      :goto_2
      :try_start_2
      move-object/from16 v0, p0
  
      iget-object v2, v0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->this$0:Lcom/android/server/backup/BackupManagerService;
--- 764,790 ----
  
      iget-object v5, v0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->mOutput:Ljava/io/OutputStream;
  
!     move-object/from16 v0, p0
! 
!     iget-object v8, v0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->mOutputFile:Landroid/os/ParcelFileDescriptor;
! 
!     invoke-virtual {v8}, Landroid/os/ParcelFileDescriptor;->getFd()I
! 
!     move-result v8
! 
!     invoke-static {v2, v3, v5, v8}, Lcom/android/server/backup/BackupManagerServiceInjector;->routeSocketDataToOutput(Lcom/android/server/backup/BackupManagerService;Landroid/os/ParcelFileDescriptor;Ljava/io/OutputStream;I)V
      :try_end_1
      .catch Ljava/io/IOException; {:try_start_1 .. :try_end_1} :catch_0
      .catchall {:try_start_1 .. :try_end_1} :catchall_0
  
      :goto_2
      :try_start_2
+     invoke-static {v4, v6}, Lcom/android/server/backup/BackupManagerServiceInjector;->needUpdateToken(Landroid/app/IBackupAgent;I)Z
+ 
+     move-result v2
+ 
+     if-eqz v2, :cond_2
+ 
      move-object/from16 v0, p0
  
      iget-object v2, v0, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->this$0:Lcom/android/server/backup/BackupManagerService;
***************
*** 831,836 ****
--- 873,881 ----
      .end local v13    # "pipes":[Landroid/os/ParcelFileDescriptor;
      :cond_4
      :goto_3
+     invoke-static {v4}, Lcom/android/server/backup/BackupManagerServiceInjector;->unlinkToDeath(Landroid/app/IBackupAgent;)V
+ 
+     :goto_miui_0
      invoke-direct/range {p0 .. p1}, Lcom/android/server/backup/BackupManagerService$FullBackupEngine;->tearDown(Landroid/content/pm/PackageInfo;)V
  
      return v14
***************
*** 1069,1073 ****
  
      const/16 v14, -0x3eb
  
!     goto/16 :goto_3
  .end method
--- 1114,1118 ----
  
      const/16 v14, -0x3eb
  
!     goto/16 :goto_miui_0
  .end method
